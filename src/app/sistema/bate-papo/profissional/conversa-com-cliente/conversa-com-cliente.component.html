<div class="main-container">
  <div class="chat-container">
    <div class="conversa-container">

      <header class="chat-header">
        <div class="back-title">
          <img
            src="/assets/icones/voltar-icon.svg"
            alt="Back"
            class="back-icon"
            (click)="goBack()"
          />
        </div>

        <div class="target-user">
          <ng-container *ngIf="targetAvatar; else initialsAvatar">
            <img class="target-avatar" [src]="targetAvatar" alt="Avatar do contato" />
          </ng-container>

          <ng-template #initialsAvatar>
            <div class="target-avatar-initial" [style.background]="getRandomColor(targetName)">
              {{ getInitial(targetName) }}
            </div>
          </ng-template>

          <div class="target-info">
            <div class="target-name">{{ targetName }}</div>
            <!-- <div class="target-sub">{{ targetSubtitle }}</div> -->
            <div class="rating">
              <span class="score">
                <span class="star">★</span>
                {{ clientRating | number:'1.1-1' }}/5
              </span>
            </div>

          </div>
        </div>
        <div class="buttons-header">
          <button class="green-button" (click)="openCodigoValidacaoModal()">Iniciar Serviço</button>
          <button class="avaliar-button" *ngIf="avaliarCliente">Avaliar Cliente</button>
        </div>
      </header>

      <section class="chat-messages" #messagesContainer>
        <div *ngFor="let message of messages"
          class="message"
          [ngClass]="{ user: message.isMe, other: !message.isMe }">

          <div class="message-content">
            <span class="message-username">{{ message.username }}</span>
            <p class="message-text">{{ message.message }}</p>
            <span class="message-timestamp">
              {{ message.timestamp | date:'dd/MM/yyyy HH:mm' }}
              <span *ngIf="message.isMe" class="message-check">✓</span>
            </span>
          </div>
        </div>
      </section>

      <footer class="chat-input">
        <form [formGroup]="chatForm" (ngSubmit)="enviarMensagem()" novalidate>
          <textarea
            #replyTextarea
            formControlName="replymessage"
            placeholder="Envie uma mensagem..."
            (keydown)="onKeydown($event)"
            (input)="autoGrow()"
            rows="1"
          ></textarea>

          <button
            type="button"
            class="send-btn"
            [disabled]="!chatForm.value.replymessage?.trim()"
            (click)="enviarMensagem()"
            aria-label="Enviar"
          >
            <img src="assets/icones/send-mens.svg" alt="Enviar" class="send-icon" />
          </button>
        </form>
      </footer>

    </div>
  </div>
</div>

<ng-template #codigoValidacaoTemplate>
  <div class="codigo-modal">
    <img
      class="codigo-modal__icon"
      src="/assets/icones/codigo-modal.svg"
      alt="Ícone de validação"
    />

    <h3 class="codigo-modal__title">
      Um código de validação foi enviado para {{ targetName }}.
    </h3>

    <p class="codigo-modal__text">
      Solicite esse código para finalizar o serviço.
    </p>

    <button class="codigo-modal__btn" (click)="closeCodigoValidacaoModal()">
      Ok, fechar
    </button>
  </div>
</ng-template>

<ng-template #servicoFinalizadoTemplate>
  <div class="finalizado-modal">
    <!-- ícone depois; por enquanto vazio (se quiser, deixe um div placeholder) -->
    <div class="finalizado-icon-placeholder"></div>

    <h3 class="finalizado-title">Serviço finalizado com sucesso!</h3>
    <p class="finalizado-text">Deseja avaliar {{ targetName }} agora?</p>

    <button class="finalizado-btn" (click)="closeServicoFinalizadoModal()">
      Ok, fechar
    </button>
  </div>
</ng-template>
